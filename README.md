# SerilogTracing

> âš  This project isn't ready to check out just yet, please drop by again soon.

An experimental Serilog extension for producing and capturing hierarchical traces.

## What is _SerilogTracing_?

_SerilogTracing_ integrates Serilog with the `System.Diagnostics.Activity*` types provided by the .NET BCL. This makes
it possible to:

 1. Record traces generated using the .NET APIs through Serilog sinks, and 
 2. Generate rich traces using Serilog APIs and idioms, that can still be observed by other consumers of the .NET APIs.
 
There are two main scenarios where these capabilities combine usefully.

First, at development time, routing trace information through Serilog means that all of the beautiful, developer-friendly
Serilog outputs can be used for simple local feedback.

Here's what that looks like, routed through Serilog's console sink:

![A screenshot of Windows Terminal showing output from the included Example application.](https://raw.githubusercontent.com/nblumhardt/serilog-tracing/dev/assets/console-output.png)

The example is using Serilog's `ExpressionTemplate` to annotate each span in the trace with timing information. The
layout is fully configurable - check out `Program.cs` in the included example project - so let your ASCII artistry run
wild!

Second, in production, Serilog's existing configuration, enrichment, filtering, formatting, and output facilities
can potentially provide a flexible mechanism for emitting trace data to a wide range of targets.

Notably, any system that accepts traces in text or JSON format should be an easy target for _SerilogTracing_ and a
Serilog sink; here's Seq showing traces delivered using the production _Serilog.Sinks.Seq_ package and a custom
`ITextFormatter` implemented with `ExpressionTemplate`:

![]

## How does it work?

And what do we mean by "tracing"?

A _trace_ is just a collection of _spans_, and a span is just an event that carries a:

 * trace id,
 * span id,
 * parent span id (optional),
 * start time, and
 * duration.

_SerilogTracing_ generates spans using extension methods on `ILogger`:

```csharp
using var activity = logger.StartActivity("Compute {A} + {B}", a, b);
// ... on `Dispose()` the activity will be recorded as a span
```

The spans generated by _SerilogTracing_ are converted into Serilog `LogEvent`s and routed through the logger. There's
nothing particularly special about these events, except that they add `ParentSpanId` and `SpanStartTimestamp`
properties to represent the parts of a span not already covered by the other parts of the `LogEvent`.

In addition to generating spans, _SerilogTracing_ can also consume spans generated elsewhere in an application via the
`System.Diagnostics.Activity` APIs, such as those produced by ASP.NET Core or `HttpClient`.

This is done using `SerilogActivityListener`:

```csharp
using var _ = SerilogActivityListener.Create();
// ... spans start flowing through `Log.Logger`
```

Finally, _SerilogTracing_ includes some examples showing how the resulting `LogEvent`s can be formatted for various
trace-aware outputs.

## Starting, enriching, and completing activities

TBA.

## Configuring the activity listener

TBA. Need a discussion of how sources can be filtered or ignored using `MinimumLevel.Override` on
the target logger.

## Formatting spans with `ExpressionTemplate`

TBA.

## Status and known limitations

This project is experimental. It's not a part of Serilog, not maintained by the Serilog maintainers, and might not
evolve in any particular way: there's currently no plan to integrate this functionality directly into Serilog. (Having
said that, this project _is_ a vehicle to explore those possibilities).

Other limitations generally stem from the project's immaturity or implementation state: if something listed here
interests you, feel free to hack away on a fork and propose any useful changes you can come up with!

 * Not much thought has been given to sampling.
 * Non-W3C id formats haven't been considered at all.
 * Activities generated by _SerilogTracing_ won't expose source names based on `ForContext<T>()` to
other `ActivityListener`s, instead marking the activities as from the generic `Serilog.Core.Logger` source. To expose
richer source names, use the generic overload of the `StartActivity` extension method.
 * _Serilog.Sinks.OpenTelemetry_, which should be a useful output for _SerilogTracing_, doesn't yet
include any support for emitting spans over OTLP.
